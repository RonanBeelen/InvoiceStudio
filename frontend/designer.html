<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Studio - Template Designer</title>
    <link rel="icon" type="image/png" href="/PNG/Icon Invoice Studio.png">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="/js/icons.js"></script>
    <style>
        /* Designer-specific styles */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .designer-header {
            display: none;
        }

        .designer-container {
            flex: 1;
            padding: var(--space-lg);
            overflow: hidden;
        }

        #designer {
            width: 100%;
            height: 100%;
            background: var(--color-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            display: none;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            gap: var(--space-md);
            color: var(--color-text-secondary);
        }

        .template-name-input {
            padding: var(--space-sm) var(--space-md);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-md);
            font-size: 14px;
            min-width: 250px;
            font-family: var(--font-family);
        }

        .template-name-input:focus {
            outline: none;
            border-color: var(--color-shamrock);
        }

        /* Choice screen styles */
        .choice-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: var(--space-xl);
            background: var(--color-background);
        }

        .choice-wrapper {
            max-width: 700px;
            width: 100%;
            text-align: center;
        }

        .choice-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .choice-card {
            background: var(--color-white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: var(--space-xl) var(--space-lg);
            cursor: pointer;
            transition: all 250ms ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-md);
        }

        .choice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 143, 122, 0.2);
            border-color: var(--color-shamrock);
        }

        .choice-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(0, 143, 122, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .choice-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .choice-desc {
            font-size: 14px;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        /* Template selection styles */
        .template-selection {
            display: none;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: var(--space-xl);
            background: var(--color-background);
        }

        .template-sel-wrapper {
            max-width: 900px;
            width: 100%;
        }

        .template-sel-header {
            display: flex;
            align-items: center;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .back-link {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            transition: all 150ms ease;
        }

        .back-link:hover {
            background: var(--color-white);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-lg);
        }

        .template-choice-card {
            background: var(--color-white);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: 0;
            cursor: pointer;
            transition: all 250ms ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        .template-choice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 143, 122, 0.2);
            border-color: var(--color-shamrock);
        }

        .preview-container {
            width: 100%;
            height: 320px;
            background: var(--color-background);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--gray-200);
            overflow: hidden;
        }

        .template-choice-info {
            padding: var(--space-md) var(--space-lg) var(--space-lg);
        }

        .template-choice-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-xs);
        }

        .template-choice-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
            line-height: 1.5;
            margin-bottom: var(--space-sm);
        }

        .template-choice-badge {
            font-size: 11px;
            color: var(--color-shamrock);
            background: rgba(0, 143, 122, 0.08);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        @media (max-width: 600px) {
            .choice-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Designer header (hidden until designer loads) -->
    <div class="header designer-header" id="designer-header">
        <div class="header-left">
            <a href="/library" class="back-btn">&larr; Terug</a>
            <h1 id="page-title" class="header-title"><i data-lucide="palette"></i> Template Designer</h1>
        </div>
        <div class="header-right">
            <input type="text" id="template-name" class="template-name-input" placeholder="Template naam" required>
            <button id="save-btn" class="btn btn-primary"><i data-lucide="save"></i> Opslaan</button>
        </div>
    </div>

    <!-- Choice screen -->
    <div class="choice-screen" id="choice-screen">
        <div class="choice-wrapper">
            <h1 style="font-size: 32px; color: var(--color-text-primary); margin-bottom: var(--space-sm); display: flex; align-items: center; justify-content: center; gap: var(--space-md);">
                <i data-lucide="palette"></i>
                Template Designer
            </h1>
            <p style="color: var(--color-text-secondary); font-size: 16px; margin-bottom: var(--space-xl);">
                Hoe wil je beginnen?
            </p>

            <div class="choice-grid">
                <button id="choice-blank" class="choice-card">
                    <div class="choice-icon">
                        <i data-lucide="pencil" style="width: 32px; height: 32px; color: var(--color-shamrock);"></i>
                    </div>
                    <div class="choice-title">Zelf Ontwerpen</div>
                    <div class="choice-desc">Start met een leeg canvas en ontwerp je template vanaf nul</div>
                </button>

                <button id="choice-template" class="choice-card">
                    <div class="choice-icon">
                        <i data-lucide="layout-template" style="width: 32px; height: 32px; color: var(--color-shamrock);"></i>
                    </div>
                    <div class="choice-title">Kiezen uit Template</div>
                    <div class="choice-desc">Begin met een voorgemaakte factuur en pas deze aan</div>
                </button>
            </div>

            <a href="/library" style="color: var(--color-text-secondary); font-size: 14px; text-decoration: none;">
                <i data-lucide="arrow-left" style="width: 14px; height: 14px; vertical-align: -2px;"></i>
                Terug naar Library
            </a>
        </div>
    </div>

    <!-- Template selection screen -->
    <div class="template-selection" id="template-selection">
        <div class="template-sel-wrapper">
            <div class="template-sel-header">
                <button id="back-to-choice" class="back-link">
                    <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                    Terug
                </button>
                <h1 style="font-size: 28px; color: var(--color-text-primary); margin: 0; display: flex; align-items: center; gap: var(--space-md);">
                    <i data-lucide="layout-template"></i>
                    Kies een template
                </h1>
            </div>

            <div id="templates-loading" class="loading">
                <div class="loader-pulse">
                    <div class="loader-pulse__ring"></div>
                    <div class="loader-pulse__ring"></div>
                    <div class="loader-pulse__ring"></div>
                    <div class="loader-pulse__dot"></div>
                </div>
                <p>Templates laden...</p>
            </div>

            <div id="templates-grid" class="templates-grid" style="display: none;"></div>
        </div>
    </div>

    <!-- Designer container (hidden until designer loads) -->
    <div class="designer-container" id="designer-container" style="display: none;">
        <div id="loading" class="loading">
            <div class="loader-pulse">
                <div class="loader-pulse__ring"></div>
                <div class="loader-pulse__ring"></div>
                <div class="loader-pulse__ring"></div>
                <div class="loader-pulse__dot"></div>
            </div>
            <p id="loading-text">Libraries laden...</p>
        </div>
        <div id="designer"></div>
    </div>

    <script type="module">
        const choiceScreen = document.getElementById('choice-screen');
        const templateSelection = document.getElementById('template-selection');
        const designerHeader = document.getElementById('designer-header');
        const designerContainer = document.getElementById('designer-container');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');

        const api = {
            async request(endpoint, options = {}) {
                const response = await fetch(endpoint, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Request failed');
                return data;
            },
            getTemplate(id) { return this.request(`/api/templates/${id}`); },
            createTemplate(data) { return this.request('/api/templates', { method: 'POST', body: JSON.stringify(data) }); },
            updateTemplate(id, data) { return this.request(`/api/templates/${id}`, { method: 'PUT', body: JSON.stringify(data) }); }
        };

        let designer, templateId, isEdit = false;

        const notify = (msg, type='info') => {
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        };

        // Show designer UI (hide choice screens)
        function showDesignerUI() {
            choiceScreen.style.display = 'none';
            templateSelection.style.display = 'none';
            designerHeader.style.display = 'flex';
            designerContainer.style.display = 'block';
            lucide.createIcons();
        }

        // Load pdfme and start designer
        async function startDesigner(presetTemplate = null) {
            showDesignerUI();

            try {
                loadingText.textContent = 'pdfme laden (dit kan even duren)...';

                const { Designer } = await import('https://cdn.jsdelivr.net/npm/@pdfme/ui@4.5.2/+esm');
                const schemas = await import('https://cdn.jsdelivr.net/npm/@pdfme/schemas@4.5.2/+esm');

                const plugins = schemas.builtInPlugins || {};
                console.log('âœ“ pdfme loaded!');

                const container = document.getElementById('designer');
                const defaultTemplate = {
                    basePdf: { width: 210, height: 297, padding: [10, 10, 10, 10] },
                    schemas: [{}]
                };

                designer = new Designer({
                    domContainer: container,
                    template: presetTemplate || defaultTemplate,
                    plugins: plugins
                });

                loading.style.display = 'none';
                container.style.display = 'block';
                notify('Designer klaar!', 'success');

                document.getElementById('save-btn').onclick = save;
            } catch (error) {
                console.error(error);
                loading.innerHTML = `
                    <p style="color: var(--color-error); font-size: 18px;"><i data-lucide="x-circle"></i> Fout</p>
                    <p style="margin: 10px 0; color: var(--color-text-secondary);">${error.message}</p>
                    <pre style="background: var(--color-white); padding: 10px; border-radius: 4px; font-size: 11px; max-width: 600px; overflow: auto; color: var(--color-text-primary);">${error.stack}</pre>
                    <p style="margin-top: 20px;"><a href="/library" class="btn btn-secondary">&larr; Terug</a></p>
                `;
            }
        }

        // Load existing template for editing
        async function loadExistingTemplate(id) {
            showDesignerUI();

            try {
                loadingText.textContent = 'Template laden...';

                const { Designer } = await import('https://cdn.jsdelivr.net/npm/@pdfme/ui@4.5.2/+esm');
                const schemas = await import('https://cdn.jsdelivr.net/npm/@pdfme/schemas@4.5.2/+esm');
                const plugins = schemas.builtInPlugins || {};

                const t = await api.getTemplate(id);
                document.getElementById('template-name').value = t.name;
                document.getElementById('page-title').innerHTML = '<i data-lucide="edit"></i> Bewerken';
                lucide.createIcons();
                templateId = id;
                isEdit = true;

                const container = document.getElementById('designer');
                designer = new Designer({
                    domContainer: container,
                    template: t.template_json,
                    plugins: plugins
                });

                loading.style.display = 'none';
                container.style.display = 'block';
                notify('Designer klaar!', 'success');

                document.getElementById('save-btn').onclick = save;
            } catch (error) {
                console.error(error);
                loading.innerHTML = `
                    <p style="color: var(--color-error); font-size: 18px;"><i data-lucide="x-circle"></i> Fout</p>
                    <p style="margin: 10px 0; color: var(--color-text-secondary);">${error.message}</p>
                    <pre style="background: var(--color-white); padding: 10px; border-radius: 4px; font-size: 11px; max-width: 600px; overflow: auto; color: var(--color-text-primary);">${error.stack}</pre>
                    <p style="margin-top: 20px;"><a href="/library" class="btn btn-secondary">&larr; Terug</a></p>
                `;
            }
        }

        // Save template
        async function save() {
            const btn = document.getElementById('save-btn');
            const name = document.getElementById('template-name').value.trim();
            if (!name) return notify('Vul naam in', 'error');

            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="lucide-spin"></i> Bezig...';
            lucide.createIcons();

            try {
                const data = { name, description: '', template_json: designer.getTemplate() };
                const result = isEdit ? await api.updateTemplate(templateId, data) : await api.createTemplate(data);
                notify(isEdit ? 'Bijgewerkt!' : 'Opgeslagen!', 'success');
                if (!isEdit) {
                    templateId = result.id;
                    isEdit = true;
                    history.pushState({}, '', `/designer?template_id=${result.id}`);
                }
            } catch (e) {
                notify('Fout: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="save"></i> Opslaan';
                lucide.createIcons();
            }
        }

        // Show template selection grid with previews
        async function showTemplateGrid() {
            choiceScreen.style.display = 'none';
            templateSelection.style.display = 'flex';

            try {
                const response = await fetch('/templates/index.json');
                const templates = await response.json();

                const grid = document.getElementById('templates-grid');
                grid.innerHTML = templates.map(t => `
                    <button class="template-choice-card" data-file="${t.file}">
                        <div class="preview-container" data-file="${t.file}">
                            <div class="loader-pulse loader-pulse--mini">
                                <div class="loader-pulse__ring"></div>
                                <div class="loader-pulse__ring"></div>
                                <div class="loader-pulse__ring"></div>
                                <div class="loader-pulse__dot"></div>
                            </div>
                        </div>
                        <div class="template-choice-info">
                            <div class="template-choice-name">${t.name}</div>
                            <div class="template-choice-desc">${t.description}</div>
                            <div class="template-choice-badge">${t.style}</div>
                        </div>
                    </button>
                `).join('');

                document.getElementById('templates-loading').style.display = 'none';
                grid.style.display = 'grid';
                lucide.createIcons();

                // Click handlers for template cards
                grid.querySelectorAll('.template-choice-card').forEach(card => {
                    card.addEventListener('click', async () => {
                        const file = card.dataset.file;
                        try {
                            const res = await fetch(`/templates/${file}`);
                            const template = await res.json();
                            await startDesigner(template);
                        } catch (err) {
                            notify('Fout bij laden template: ' + err.message, 'error');
                            await startDesigner(null);
                        }
                    });
                });

                // Load previews asynchronously
                loadPreviews(templates);
            } catch (error) {
                document.getElementById('templates-loading').innerHTML = `
                    <p style="color: var(--color-error);">Fout bij het laden van templates: ${error.message}</p>
                `;
            }
        }

        // Load and render PDF previews
        async function loadPreviews(templates) {
            const pdfjsLib = await import('https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/+esm');
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.mjs';

            const promises = templates.map(async (t) => {
                const container = document.querySelector(`.preview-container[data-file="${t.file}"]`);
                if (!container) return;

                try {
                    const templateRes = await fetch(`/templates/${t.file}`);
                    const templateJson = await templateRes.json();

                    const previewRes = await fetch('/api/preview', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ template: templateJson })
                    });
                    const previewData = await previewRes.json();

                    if (!previewData.success || !previewData.pdf) {
                        container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 12px;">Preview niet beschikbaar</p>';
                        return;
                    }

                    const pdfData = atob(previewData.pdf);
                    const pdfArray = new Uint8Array(pdfData.length);
                    for (let i = 0; i < pdfData.length; i++) {
                        pdfArray[i] = pdfData.charCodeAt(i);
                    }

                    const pdf = await pdfjsLib.getDocument({ data: pdfArray }).promise;
                    const page = await pdf.getPage(1);

                    const containerWidth = container.offsetWidth;
                    const viewport = page.getViewport({ scale: 1 });
                    const scale = (containerWidth - 20) / viewport.width;
                    const scaledViewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;
                    canvas.style.maxWidth = '100%';
                    canvas.style.maxHeight = '100%';
                    canvas.style.objectFit = 'contain';

                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;

                    container.innerHTML = '';
                    container.appendChild(canvas);
                } catch (err) {
                    console.error(`Preview failed for ${t.file}:`, err);
                    container.innerHTML = '<p style="color: var(--color-text-secondary); font-size: 12px;">Preview niet beschikbaar</p>';
                }
            });

            await Promise.all(promises);
        }

        // Initialize icons
        lucide.createIcons();

        // Check if editing existing template
        const params = new URLSearchParams(location.search);
        const id = params.get('template_id');

        if (id) {
            // Editing existing template - skip choice screen
            await loadExistingTemplate(id);
        } else {
            // New template - show choice screen
            // "Zelf ontwerpen" handler
            document.getElementById('choice-blank').addEventListener('click', () => {
                startDesigner(null);
            });

            // "Kiezen uit template" handler
            document.getElementById('choice-template').addEventListener('click', () => {
                showTemplateGrid();
            });

            // Back to choice screen handler
            document.getElementById('back-to-choice').addEventListener('click', () => {
                templateSelection.style.display = 'none';
                choiceScreen.style.display = 'flex';
            });
        }
    </script>
</body>
</html>
